<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complex Encryption System</title>
</head>

<body>
    <h1>Encryption/Decryption System</h1>
    <div>
        <h2>Encrypt Message</h2>
        <textarea id="messageToEncrypt" rows="4" cols="50"></textarea><br><br>
        <button onclick="encryptMessage()">Encrypt</button><br><br>
        <p><strong>Encrypted Message:</strong></p>
        <textarea id="encryptedMessage" rows="4" cols="50" readonly></textarea>
    </div>

    <div>
        <h2>Decrypt Message</h2>
        <textarea id="messageToDecrypt" rows="4" cols="50"></textarea><br><br>
        <button onclick="decryptMessage()">Decrypt</button><br><br>
        <p><strong>Decrypted Message:</strong></p>
        <textarea id="decryptedMessage" rows="4" cols="50" readonly></textarea>
    </div>

    <script>
        // Helper function to convert a string to an array buffer
        async function strToArrayBuffer(str) {
            const encoder = new TextEncoder();
            return encoder.encode(str);
        }

        // Helper function to generate a random encryption key (AES key)
        async function generateKey() {
            const key = await crypto.subtle.generateKey(
                {
                    name: "AES-GCM",
                    length: 256, // 256-bit key for AES
                },
                true,
                ["encrypt", "decrypt"]
            );
            return key;
        }

        // Encrypt the message
        async function encryptMessage() {
            const message = document.getElementById("messageToEncrypt").value;
            if (!message) return alert("Please enter a message to encrypt.");

            // Generate a unique encryption key for this session
            const key = await generateKey();

            // Convert the message to an array buffer
            const encodedMessage = await strToArrayBuffer(message);

            // Generate a random initialization vector (IV)
            const iv = crypto.getRandomValues(new Uint8Array(12)); // AES-GCM requires a 12-byte IV

            // Encrypt the message
            const encryptedBuffer = await crypto.subtle.encrypt(
                {
                    name: "AES-GCM",
                    iv: iv,
                },
                key,
                encodedMessage
            );

            // Combine the IV and the encrypted message for storage (base64 encoded)
            const combinedData = new Uint8Array(iv.length + encryptedBuffer.byteLength);
            combinedData.set(iv, 0);
            combinedData.set(new Uint8Array(encryptedBuffer), iv.length);

            // Store the encryption key for decryption
            const exportedKey = await crypto.subtle.exportKey("jwk", key);
            localStorage.setItem("encryptionKey", JSON.stringify(exportedKey));

            const encryptedMessage = btoa(String.fromCharCode.apply(null, combinedData));
            document.getElementById("encryptedMessage").value = encryptedMessage;
        }

        // Decrypt the message
        async function decryptMessage() {
            const encryptedMessage = document.getElementById("messageToDecrypt").value;
            if (!encryptedMessage) return alert("Please enter a message to decrypt.");

            // Retrieve the stored encryption key
            const storedKey = localStorage.getItem("encryptionKey");
            if (!storedKey) return alert("No key found. Please encrypt a message first.");

            // Re-import the key from storage
            const importedKey = await crypto.subtle.importKey(
                "jwk",
                JSON.parse(storedKey),
                { name: "AES-GCM" },
                true,
                ["decrypt"]
            );

            // Convert the base64 encoded message back to bytes
            const encryptedData = new Uint8Array(atob(encryptedMessage).split("").map(char => char.charCodeAt(0)));

            // Extract the IV (first 12 bytes)
            const iv = encryptedData.slice(0, 12);

            // Extract the encrypted message (after the IV)
            const encryptedBuffer = encryptedData.slice(12);

            // Decrypt the message using the stored key and IV
            try {
                const decryptedBuffer = await crypto.subtle.decrypt(
                    {
                        name: "AES-GCM",
                        iv: iv,
                    },
                    importedKey,
                    encryptedBuffer
                );

                // Convert the decrypted buffer back to a string
                const decoder = new TextDecoder();
                const decryptedMessage = decoder.decode(decryptedBuffer);
                document.getElementById("decryptedMessage").value = decryptedMessage;
            } catch (error) {
                alert("Decryption failed! Invalid or mismatched data.");
            }
        }
    </script>
</body>

</html>
